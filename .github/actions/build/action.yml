name: Build
description: Install dependencies, lint, test, build, and prune
inputs:
  google-client-id:
    description: Google OAuth client ID for frontend build
    required: true
runs:
  using: composite
  steps:
    - uses: actions/checkout@v4

    - uses: actions/setup-node@v4
      with:
        node-version: 22
        cache: npm
        cache-dependency-path: |
          backend/package-lock.json
          frontend/package-lock.json

    - name: Install dependencies
      run: |
        npm --prefix backend ci &
        npm --prefix frontend ci &
        wait
      shell: bash

    - name: Lint frontend and test backend
      run: |
        npm --prefix frontend run lint &
        DATABASE_URL=postgres://postgres:postgres@localhost:5432/promptswap_test npm --prefix backend test &
        wait
      shell: bash

    - name: Build frontend and backend
      env:
        VITE_GOOGLE_CLIENT_ID: ${{ inputs.google-client-id }}
      run: |
        npm --prefix frontend run build &
        npm --prefix backend run build &
        wait
      shell: bash

    - name: Prune production dependencies
      run: |
        npm --prefix frontend prune --production &
        npm --prefix backend prune --production &
        wait
      shell: bash
